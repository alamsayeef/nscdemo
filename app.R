#
# This is a Shiny web application to provide a demo preview of Nordic Shortfall Calculator.
# You can run the application by clicking the 'Run App' button above.
#

library(shiny)
library(tibble)
library(bslib)
library(dplyr)
library(lubridate)
library(plotly)
library(rlang)
library(highcharter)

# functions ----

# compute QALE
compQale = function(
    ons_df,                   
    prop_female = 0.5, 
    start_age = 50, 
    disc_rate = 0.035,
    utils = "cw"
){
  
  compQaleInternal = function(
    ons_df,                   
    prop_female = 0.5, 
    start_age = 50, 
    disc_rate = 0.035,
    utils = "cw"
  ){
    
    ons_df = ons_df[ons_df$age >= start_age,]
    ons_df = ons_df[order(ons_df$age),]
    df_female = ons_df[ons_df$sex == "female", c("age",utils,"lx","dx","mx","ex")]
    df_male = ons_df[ons_df$sex == "male",c("age",utils,"lx","dx","mx","ex")]
    
    df_comp = data.frame(
      age = df_female$age,
      utils = (1-prop_female) * df_male[,utils]  + prop_female * df_female[,utils],
      lx = (1-prop_female) * df_male$lx  + prop_female * df_female$lx,
      dx = (1-prop_female) * df_male$dx  + prop_female * df_female$dx,
      mx = (1-prop_female) * df_male$mx  + prop_female * df_female$mx,
      ex = (1-prop_female) * df_male$ex  + prop_female * df_female$ex
    )
    
    # person years in year i
    df_comp$Lx = NA
    for(i in 2:nrow(df_comp)){
      df_comp$Lx[i-1] = df_comp$lx[i] + (0.5 * df_comp$dx[i-1])
    }
    df_comp$Lx[nrow(df_comp)] = (df_comp$lx[nrow(df_comp)]-df_comp$dx[nrow(df_comp)]) + (0.5 * df_comp$dx[nrow(df_comp)])
    
    # person QALYs in year i
    df_comp$Yx = df_comp$utils * df_comp$Lx
    
    # apply discounting
    v_disc <- 1/(1+disc_rate)^(0:(length(df_comp$Yx)-1))
    df_comp$Yx = df_comp$Yx * v_disc
    
    # remaining person QALYs?
    df_comp$Nx = NA
    df_comp$Nx[nrow(df_comp)] = df_comp$Yx[nrow(df_comp)]
    for(i in nrow(df_comp):2){
      df_comp$Nx[i-1] = df_comp$Yx[i-1] + df_comp$Nx[i]
    }
    
    # Quality adjusted life expectancy 
    df_comp$Qx = df_comp$Nx / df_comp$lx
    
    
    q_factor = sum(df_comp$Yx) / df_comp$Qx[1]
    
    df_comp$qalys_by_year = df_comp$Yx/q_factor 
    df_comp$cumulative_qalys = cumsum(df_comp$qalys_by_year)
    
    # cumulative survival function
    df_comp$S = 1-df_comp$mx
    df_comp$S_cumulativ =  cumprod(df_comp$S)
    df_comp$hrqol = df_comp$utils
    
    df_comp = df_comp[,c("age","hrqol","ex","Qx","S_cumulativ","cumulative_qalys")]
    
    return(df_comp)
    
  }
  
  
  qale_male = compQaleInternal(
    ons_df = ons_df,                   
    prop_female = 0, 
    start_age = start_age, 
    disc_rate = disc_rate,
    utils = utils
  )
  qale_female = compQaleInternal(
    ons_df = ons_df,                   
    prop_female = 1, 
    start_age = start_age, 
    disc_rate = disc_rate,
    utils = utils
  )
  qale_mix = qale_male * (1-prop_female) + qale_female * prop_female
  
  return(qale_mix)
  
}

# function for consistent 2 decimal digits ----
fRound = function(str, digits = 2, width = 2){
  formatC(str, digits = 2, width = 2, format = "f")
}

# function for sidebar ----
create_accordion_panel = function(country, prefix, selected = FALSE) {
  accordion_panel(
    country,
    sliderInput(
      paste0(prefix, "_start_age"),
      "Age of the patient population",
      min = 0,
      max = 100,
      value = 0,
      step = 1
    ),
    sliderInput(
      paste0(prefix, "_sex_mix"),
      "% female in the patient population",
      min = 0,
      max = 100,
      value = 50,
      step = 1
    ),
    selectInput(
      paste0(prefix, "_utils"),
      "Select scenario",
      choices = list(
        "Reference case: MVH value set + HSE 2014 ALDVMM model (Hernandez Alava et al)" = paste0(prefix, "_dsu_2014"),
        "Alternative A: 5L to 3L mapping (Hernandez Alava et al) + HSE 2017-2018" = paste0(prefix, "_dsu"),
        "Alternative B: 5L to 3L mapping (van Hout et al) + HSE 2017-2018" = paste0(prefix, "_vanHout"),
        "Alternative C: MVH value set + health state profiles" = paste0(prefix, "_mvh"),
        "Alternative D: MVH value set + HSE 2012+14" = paste0(prefix, "_tto")
      ),
      selected = paste0(prefix, "_dsu_2014")
    ),
    sliderInput(
      paste0(prefix, "_remaining_qalys"),
      "Remaining QALYS",
      min = 0,
      max = 49,
      value = 10,
      step = 1
    ),
    sliderInput(
      paste0(prefix, "_disc_rate"),
      "Discount rate",
      min = 0,
      max = 10,
      value = 1.5,
      step = 0.5
    ),
    selected = selected  # Set selected argument
  )
}

sidebar_acc = accordion(open = F,
                        create_accordion_panel("Norway", "n")
)

# function to create CS, HRQoL & CQ highchart ----
create_highchart <- function(plot_df, title, ytitle, y_max, color = "#7cb5ec") {
  highchart(
    hc_opts = list(),
    theme = getOption("highcharter.theme"),
    type = "chart",
    width = NULL,
    height = NULL,
    elementId = NULL,
    google_fonts = getOption("highcharter.google_fonts")
  ) %>%
    hc_add_series(
      plot_df, type = "area",
      name = "Shortfall", color = color,
      hcaes(x = "age", y = "var"),
      tooltip = list(enabled = FALSE),
      fast = TRUE
    ) %>%
    hc_title(
      text = title,
      y = 60, x = -50,
      style = list(fontSize = "16px")
    ) %>%
    hc_plotOptions(
      line = list(
        marker = list(
          enabled = FALSE
        )
      ),
      series = list(
        tooltip = list(
          enabled = TRUE,
          followPointer = TRUE,
          fillColor = "transparent"
        )
      ),
      area = list(
        states = list(
          hover = list(
            enabled = TRUE
          )
        ),
        marker = list(
          enabled = FALSE,
          fillColor = "blue",
          width = 1,
          height = 1,
          enabledThreshold = 10,
          radius = 1
        )
      )
    ) %>%
    hc_xAxis(
      title = list(text = "Age"),
      gridLineColor = 'lightgray',
      gridLineWidth = 1,
      gridLineDashStyle = "Dot",
      tickLength = 10,
      tickWidth = 2,
      tickmarkPlacement = 'between'
    ) %>%
    hc_yAxis(
      title = list(text = ytitle),
      max = y_max
    ) %>%
    hc_tooltip(
      enabled = TRUE,
      valueDecimals = 2,
      pointFormat = '{point.y} ',
      valueSuffix = ' '
    ) %>%
    hc_chart(
      style = list(
        fontFamily = "Inter"
      )
    ) %>%
    hc_legend(
      enabled = FALSE
    )
}

# funciton for AS highchart ----
create_highchart_as <- function(data, remaining_qalys, color) {
  if (data$shortfall_abs < 0) {
    p_error <- highchart() %>%
      hc_title(
        text = "Error: QALYs must be lower with the disease.",
        align = "center",
        x = -10,
        verticalAlign = 'middle',
        floating = TRUE,
        style = list(
          fontSize = "16px",
          color = color
        )
      )
    return(p_error)
  } else {
    short_fall <- data.frame(
      name = c("QALYs with disease", "Absolute shortfall", "QALYs without disease"),
      value = c(remaining_qalys, data$shortfall_abs, max(data$res$Qx[1])),
      color = c(color, "#6d757d", "#3e6386"),
      a = c(FALSE, FALSE, TRUE)
    )
    
    shortfall_str <- paste0("Absolute QALY shortfall:<b>", round(data$shortfall_abs, 2), "</b>")
    
    p1 <- highchart() %>%
      hc_add_series(
        data = short_fall, "waterfall",
        pointPadding = "0",
        hcaes(
          name = name,
          y = value,
          isSum = a,
          color = color
        ),
        name = "QALYs"
      ) %>%
      hc_chart(
        style = list(
          fontFamily = "Inter"
        )
      ) %>%
      hc_tooltip(
        valueDecimals = 2
      ) %>%
      hc_xAxis(
        categories = short_fall$name
      ) %>%
      hc_boost(enabled = FALSE)
    
    return(p1)
  }
}

# function to generate nav_panel for each country ----
generate_nav_panel <- function(country, id_prefix) {
  nav_panel(
    country,
    h1(paste("Remaining QALYs for", country)),
    layout_column_wrap(
      width = 1/5,
      card(fill = FALSE, card_header("without the disease:"), card_body(uiOutput(paste0(id_prefix, "_qales_healthy_txt")))),
      card(fill = FALSE, card_header("with the disease:"), card_body(uiOutput(paste0(id_prefix, "_qales_ill_txt")))),
      card(fill = FALSE, card_header("absolute shortfall:"), card_body(uiOutput(paste0(id_prefix, "_abs_short_txt")))),
      card(fill = FALSE, card_header("proportional shortfall:"), card_body(uiOutput(paste0(id_prefix, "_prop_short_txt")))),
      card(fill = FALSE, card_header("QALY weight:"), card_body(uiOutput(paste0(id_prefix, "_mltplr_txt"))))
    ),
    layout_column_wrap(
      width = 1/2,
      navset_card_tab(
        height = 450,
        full_screen = TRUE,
        title = "Shortfall",
        nav_panel("Absolute", card_body(highchartOutput(paste0(id_prefix, "_hc_as")))),
        nav_panel("Proportional", card_body(highchartOutput(paste0(id_prefix, "_hc_ps"))))
      ),
      navset_card_tab(
        height = 450,
        full_screen = TRUE,
        title = "Other",
        nav_panel("Cumulative QALYs", card_body(highchartOutput(paste0(id_prefix, "_hc_cq")))),
        nav_panel("HRQoL by year", card_body(highchartOutput(paste0(id_prefix, "_hc_hrqol")))),
        nav_panel("Cumulative Survival", card_body(highchartOutput(paste0(id_prefix, "_hc_cs"))))
      )
    )
  )
}

# load data ----
# Define the columns
age1 <- rep(0:100, each = 2)
sex1 <- rep(c('female', 'male'), times = 101)
age_start1 <- c(rep(18, times = 50),
               rep(25, times = 20), 
               rep(35, times = 20), 
               rep(45, times = 20), 
               rep(55, times = 20), 
               rep(65, times = 20), 
               rep(75, times = 52))
age5_str1 <- c(rep('18-24', times = 50),
              rep('25-34', times = 20), 
              rep('35-44', times = 20), 
              rep('45-54', times = 20), 
              rep('55-64', times = 20), 
              rep('65-74', times = 20), 
              rep('75+', times = 52))
tto1 <- c(rep(0.94, times = 50), 
         rep(0.93, times = 20), 
         rep(0.91, times = 20), 
         rep(0.85, times = 10), 
         rep(0.84, times = 10), 
         rep(0.81, times = 10), 
         rep(0.78, times = 30), 
         rep(0.75, times = 26), 
         rep(0.71, times = 26))
mx1 = c(0.003582, 0.004321, 0.000213, 0.000242, 0.000125, 0.000132, 9.8e-05, 0.000102, 6.4e-05, 9.4e-05, 8.5e-05, 8.9e-05, 7.9e-05, 8.3e-05, 6.1e-05, 7.3e-05, 6.4e-05, 6.4e-05, 5.6e-05, 6.2e-05, 6.4e-05, 7.2e-05, 6.2e-05, 8.1e-05, 5.7e-05, 0.000105, 7.9e-05, 0.000125, 9.2e-05, 0.000116, 9.8e-05, 0.000169, 0.000148, 0.00022, 0.000159, 0.000303, 0.000211, 0.000387, 0.000194, 0.000415, 0.000179, 0.000503, 0.000201, 0.000498, 0.000215, 0.000479, 2e-04, 0.00047, 0.000218, 0.000513, 0.000244, 0.000538, 0.000259, 0.000543, 0.00027, 0.000574, 0.000304, 0.000629, 0.000302, 0.000664, 0.000358, 0.000711, 0.000369, 0.000772, 0.000436, 0.000756, 0.000451, 0.000861, 0.000525, 0.000893, 0.000554, 0.000968, 0.000583, 0.001051, 0.000746, 0.001212, 0.000703, 0.001179, 0.000771, 0.001291, 0.000829, 0.001431, 0.000916, 0.001535, 0.001028, 0.001678, 0.001098, 0.001853, 0.001261, 0.001962, 0.001361, 0.002226, 0.001495, 0.002306, 0.00162, 0.002573, 0.001772, 0.002719, 0.001899, 0.003047, 0.002091, 0.003239, 0.002277, 0.003496, 0.002478, 0.003755, 0.002591, 0.004021, 0.002773, 0.004318, 0.003089, 0.004653, 0.0034, 0.005192, 0.003689, 0.005695, 0.004082, 0.006208, 0.004403, 0.006728, 0.004852, 0.007414, 0.005299, 0.008049, 0.006098, 0.008998, 0.006478, 0.009929, 0.007006, 0.010735, 0.007698, 0.011872, 0.008278, 0.012985, 0.009053, 0.01416, 0.010082, 0.01549, 0.01088, 0.016987, 0.01203, 0.017956, 0.01297, 0.02001, 0.014884, 0.021869, 0.017035, 0.025311, 0.018668, 0.027602, 0.020912, 0.030891, 0.023611, 0.034948, 0.026807, 0.03867, 0.030388, 0.043514, 0.034189, 0.048056, 0.038372, 0.054329, 0.043276, 0.060667, 0.049059, 0.067296, 0.056819, 0.076235, 0.064521, 0.087106, 0.074049, 0.09777, 0.085076, 0.111136, 0.096453, 0.124636, 0.110923, 0.141065, 0.124474, 0.160029, 0.140894, 0.171303, 0.159746, 0.194057, 0.18005, 0.215207, 0.201066, 0.239683, 0.226271, 0.268883, 0.255483, 0.301158, 0.286263, 0.339814, 0.308323, 0.360074, 0.343826, 0.390059, 0.373434, 0.45198, 0.424693, 0.481498)
qx1 = c(0.003576, 0.004312, 0.000213, 0.000242, 0.000125, 0.000132, 9.8e-05, 0.000102, 6.4e-05, 9.4e-05, 8.5e-05, 8.9e-05, 7.9e-05, 8.3e-05, 6.1e-05, 7.3e-05, 6.4e-05, 6.4e-05, 5.6e-05, 6.2e-05, 6.4e-05, 7.2e-05, 6.2e-05, 8.1e-05, 5.7e-05, 0.000105, 7.9e-05, 0.000125, 9.2e-05, 0.000116, 9.8e-05, 0.000169, 0.000148, 0.00022, 0.000159, 0.000303, 0.000211, 0.000387, 0.000194, 0.000415, 0.000179, 0.000503, 0.000201, 0.000498, 0.000215, 0.000478, 2e-04, 0.00047, 0.000218, 0.000513, 0.000244, 0.000538, 0.000259, 0.000543, 0.00027, 0.000574, 0.000304, 0.000629, 0.000302, 0.000664, 0.000358, 0.000711, 0.000369, 0.000772, 0.000436, 0.000755, 0.000451, 0.000861, 0.000525, 0.000892, 0.000554, 0.000967, 0.000583, 0.00105, 0.000746, 0.001211, 0.000703, 0.001178, 0.00077, 0.00129, 0.000828, 0.00143, 0.000916, 0.001534, 0.001027, 0.001676, 0.001098, 0.001851, 0.00126, 0.00196, 0.00136, 0.002223, 0.001494, 0.002304, 0.001618, 0.00257, 0.00177, 0.002715, 0.001897, 0.003042, 0.002089, 0.003233, 0.002274, 0.00349, 0.002474, 0.003748, 0.002587, 0.004013, 0.00277, 0.004309, 0.003084, 0.004642, 0.003395, 0.005178, 0.003682, 0.005678, 0.004073, 0.006189, 0.004393, 0.006705, 0.004841, 0.007386, 0.005285, 0.008017, 0.006079, 0.008958, 0.006457, 0.00988, 0.006982, 0.010678, 0.007668, 0.011802, 0.008244, 0.012901, 0.009012, 0.01406, 0.010032, 0.015371, 0.010821, 0.016844, 0.011958, 0.017796, 0.012887, 0.019812, 0.014774, 0.021632, 0.016891, 0.024995, 0.018495, 0.027226, 0.020696, 0.030421, 0.023336, 0.034348, 0.026453, 0.037937, 0.029934, 0.042587, 0.033615, 0.046928, 0.03765, 0.052892, 0.042359, 0.058881, 0.047884, 0.065106, 0.05525, 0.073435, 0.062504, 0.083471, 0.071406, 0.093214, 0.081605, 0.105286, 0.092016, 0.117324, 0.105094, 0.131771, 0.117181, 0.148173, 0.131622, 0.157788, 0.14793, 0.176893, 0.165179, 0.1943, 0.182699, 0.214033, 0.203273, 0.237018, 0.226544, 0.261745, 0.25042, 0.290462, 0.26714, 0.305138, 0.293389, 0.326401, 0.314678, 0.368665, 0.350306, 0.38807)
lx1 = c(1e+05, 1e+05, 99642.4, 99568.8, 99621.2, 99544.7, 99608.8, 99531.5, 99599, 99521.4, 99592.6, 99512, 99584.1, 99503.1, 99576.3, 99494.8, 99570.3, 99487.5, 99563.9, 99481.1, 99558.3, 99475, 99551.9, 99467.8, 99545.8, 99459.7, 99540.1, 99449.3, 99532.2, 99436.9, 99523.1, 99425.4, 99513.3, 99408.5, 99498.6, 99386.7, 99482.8, 99356.5, 99461.8, 99318, 99442.6, 99276.8, 99424.8, 99226.9, 99404.8, 99177.4, 99383.4, 99130, 99363.5, 99083.4, 99341.9, 99032.6, 99317.7, 98979.3, 99291.9, 98925.6, 99265.1, 98868.8, 99234.9, 98806.7, 99204.9, 98741.1, 99169.4, 98670.9, 99132.9, 98594.7, 99089.7, 98520.2, 99045, 98435.4, 98993, 98347.6, 98938.1, 98252.5, 98880.5, 98149.3, 98806.7, 98030.4, 98737.2, 97914.9, 98661.2, 97788.6, 98579.5, 97648.7, 98489.2, 97498.9, 98388, 97335.5, 98280, 97155.3, 98156.2, 96964.9, 98022.7, 96749.3, 97876.3, 96526.4, 97717.9, 96278.4, 97544.9, 96017, 97359.9, 95724.8, 97156.5, 95415.3, 96935.5, 95082.3, 96695.6, 94725.9, 96445.5, 94345.8, 96178.3, 93939.3, 95881.7, 93503.2, 95556.2, 93019, 95204.4, 92490.8, 94816.6, 91918.3, 94400, 91302, 93943.1, 90627.6, 93446.6, 89901.1, 92878.5, 89095.8, 92278.7, 88215.5, 91634.5, 87273.5, 90931.8, 86243.5, 90182.1, 85130.9, 89369.4, 83933.9, 88472.9, 82643.8, 87515.5, 81251.8, 86469, 79805.8, 85354.7, 78224.7, 84093.7, 76532.5, 82673.2, 74619.6, 81144.2, 72588, 79464.8, 70379.8, 77610.5, 67962.4, 75557.5, 65384.2, 73295.7, 62599.6, 70831.9, 59662, 68165.1, 56506.3, 65277.7, 53179.2, 62152, 49716.9, 58718.1, 46065.9, 55047.9, 42220.8, 51117.2, 38285.2, 46945.8, 34254.4, 42626.1, 30235.5, 38146.3, 26251.3, 33676.3, 22361.6, 29243.8, 18833.2, 24917.7, 15501.7, 20801.8, 12489.8, 17001.4, 9816.5, 13545.4, 7489.8, 10476.8, 5529.4, 7853.2, 3923.3, 5755.3, 2726.2, 4066.8, 1836.3, 2787, 1159.3)
dx1 = c(357.6, 431.2, 21.2, 24.1, 12.4, 13.2, 9.8, 10.1, 6.4, 9.4, 8.5, 8.9, 7.8, 8.3, 6, 7.3, 6.3, 6.4, 5.6, 6.2, 6.4, 7.2, 6.2, 8.1, 5.6, 10.4, 7.9, 12.4, 9.1, 11.5, 9.8, 16.8, 14.7, 21.9, 15.8, 30.2, 20.9, 38.5, 19.3, 41.2, 17.8, 49.9, 20, 49.4, 21.4, 47.5, 19.9, 46.6, 21.6, 50.8, 24.3, 53.3, 25.7, 53.7, 26.9, 56.7, 30.2, 62.1, 30, 65.6, 35.5, 70.2, 36.6, 76.2, 43.2, 74.5, 44.7, 84.8, 52, 87.8, 54.8, 95.1, 57.7, 103.2, 73.8, 118.9, 69.4, 115.5, 76.1, 126.3, 81.7, 139.8, 90.2, 149.8, 101.2, 163.4, 108, 180.2, 123.8, 190.4, 133.5, 215.6, 146.4, 222.9, 158.4, 248.1, 173, 261.4, 185, 292.1, 203.4, 309.5, 221, 333, 239.9, 356.4, 250.2, 380.1, 267.1, 406.5, 296.6, 436.1, 325.5, 484.2, 351.9, 528.2, 387.8, 572.4, 416.5, 616.3, 456.9, 674.4, 496.5, 726.5, 568.1, 805.3, 599.7, 880.3, 644.3, 942, 702.7, 1030, 749.7, 1112.6, 812.7, 1197, 896.5, 1290.1, 957.3, 1392.1, 1046.6, 1446, 1114.3, 1581.1, 1261, 1692.2, 1420.4, 1912.9, 1529.1, 2031.6, 1679.4, 2208.2, 1854.4, 2417.4, 2053, 2578.3, 2261.7, 2784.5, 2463.8, 2937.7, 2666.8, 3155.7, 2887.4, 3327.1, 3125.8, 3462.3, 3433.9, 3651, 3670.1, 3845.2, 3930.7, 3935.5, 4171.4, 4030.9, 4319.7, 4018.9, 4479.8, 3984.2, 4470, 3889.7, 4432.5, 3528.4, 4326, 3331.5, 4115.9, 3012, 3800.5, 2673.2, 3455.9, 2326.7, 3068.6, 1960.4, 2623.6, 1606.1, 2097.9, 1197.2, 1688.5, 889.8, 1279.7, 677, 976.3, 449.9)
ex1 = c(83.33, 79.67, 82.63, 79.02, 81.65, 78.04, 80.66, 77.05, 79.67, 76.06, 78.67, 75.06, 77.68, 74.07, 76.68, 73.08, 75.69, 72.08, 74.69, 71.09, 73.7, 70.09, 72.7, 69.09, 71.71, 68.1, 70.71, 67.11, 69.72, 66.12, 68.72, 65.12, 67.73, 64.13, 66.74, 63.15, 65.75, 62.17, 64.76, 61.19, 63.78, 60.22, 62.79, 59.25, 61.8, 58.28, 60.81, 57.3, 59.82, 56.33, 58.84, 55.36, 57.85, 54.39, 56.87, 53.42, 55.88, 52.45, 54.9, 51.48, 53.92, 50.51, 52.93, 49.55, 51.95, 48.59, 50.98, 47.62, 50, 46.66, 49.03, 45.71, 48.05, 44.75, 47.08, 43.8, 46.11, 42.85, 45.15, 41.9, 44.18, 40.95, 43.22, 40.01, 42.26, 39.07, 41.3, 38.14, 40.34, 37.21, 39.39, 36.28, 38.45, 35.36, 37.5, 34.44, 36.56, 33.53, 35.63, 32.62, 34.69, 31.71, 33.77, 30.81, 32.84, 29.92, 31.92, 29.03, 31, 28.15, 30.09, 27.27, 29.18, 26.39, 28.28, 25.53, 27.38, 24.67, 26.49, 23.82, 25.61, 22.98, 24.73, 22.14, 23.86, 21.32, 23, 20.51, 22.15, 19.71, 21.3, 18.91, 20.46, 18.13, 19.62, 17.36, 18.8, 16.6, 17.98, 15.86, 17.17, 15.12, 16.38, 14.38, 15.58, 13.66, 14.81, 12.96, 14.06, 12.27, 13.31, 11.6, 12.58, 10.95, 11.87, 10.32, 11.18, 9.71, 10.51, 9.12, 9.86, 8.55, 9.22, 8, 8.61, 7.46, 8.02, 6.95, 7.46, 6.46, 6.92, 6, 6.41, 5.57, 5.94, 5.17, 5.49, 4.79, 5.08, 4.44, 4.68, 4.12, 4.32, 3.8, 3.98, 3.51, 3.67, 3.23, 3.38, 2.98, 3.11, 2.75, 2.88, 2.55, 2.67, 2.38, 2.47, 2.21, 2.28, 2.04, 2.1, 1.94)

n_mvh_df <- tibble(age = age1, 
                   sex = sex1, 
                   age_start = age_start1, 
                   age5_str = age5_str1, 
                   tto = tto1,
                   mx = mx1,
                   qx = qx1,
                   lx = lx1,
                   dx = dx1,
                   ex = ex1
)

age2 = c(0, 0, 1, 1, 10, 10, 100, 100, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 2, 2, 20, 20, 21, 21, 22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 27, 28, 28, 29, 29, 3, 3, 30, 30, 31, 31, 32, 32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 37, 38, 38, 39, 39, 4, 4, 40, 40, 41, 41, 42, 42, 43, 43, 44, 44, 45, 45, 46, 46, 47, 47, 48, 48, 49, 49, 5, 5, 50, 50, 51, 51, 52, 52, 53, 53, 54, 54, 55, 55, 56, 56, 57, 57, 58, 58, 59, 59, 6, 6, 60, 60, 61, 61, 62, 62, 63, 63, 64, 64, 65, 65, 66, 66, 67, 67, 68, 68, 69, 69, 7, 7, 70, 70, 71, 71, 72, 72, 73, 73, 74, 74, 75, 75, 76, 76, 77, 77, 78, 78, 79, 79, 8, 8, 80, 80, 81, 81, 82, 82, 83, 83, 84, 84, 85, 85, 86, 86, 87, 87, 88, 88, 89, 89, 9, 9, 90, 90, 91, 91, 92, 92, 93, 93, 94, 94, 95, 95, 96, 96, 97, 97, 98, 98, 99, 99)
sex2 = rep(c('female', 'male'), times = 101)
age5_str2 = c('16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '90+', '90+', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '16-17', '18-19', '18-19', '18-19', '18-19', '16-17', '16-17', '20-24', '20-24', '20-24', '20-24', '20-24', '20-24', '20-24', '20-24', '20-24', '20-24', '25-29', '25-29', '25-29', '25-29', '25-29', '25-29', '25-29', '25-29', '25-29', '25-29', '16-17', '16-17', '30-34', '30-34', '30-34', '30-34', '30-34', '30-34', '30-34', '30-34', '30-34', '30-34', '35-39', '35-39', '35-39', '35-39', '35-39', '35-39', '35-39', '35-39', '35-39', '35-39', '16-17', '16-17', '40-44', '40-44', '40-44', '40-44', '40-44', '40-44', '40-44', '40-44', '40-44', '40-44', '45-49', '45-49', '45-49', '45-49', '45-49', '45-49', '45-49', '45-49', '45-49', '45-49', '16-17', '16-17', '50-54', '50-54', '50-54', '50-54', '50-54', '50-54', '50-54', '50-54', '50-54', '50-54', '55-59', '55-59', '55-59', '55-59', '55-59', '55-59', '55-59', '55-59', '55-59', '55-59', '16-17', '16-17', '60-64', '60-64', '60-64', '60-64', '60-64', '60-64', '60-64', '60-64', '60-64', '60-64', '65-69', '65-69', '65-69', '65-69', '65-69', '65-69', '65-69', '65-69', '65-69', '65-69', '16-17', '16-17', '70-74', '70-74', '70-74', '70-74', '70-74', '70-74', '70-74', '70-74', '70-74', '70-74', '75-79', '75-79', '75-79', '75-79', '75-79', '75-79', '75-79', '75-79', '75-79', '75-79', '16-17', '16-17', '80-84', '80-84', '80-84', '80-84', '80-84', '80-84', '80-84', '80-84', '80-84', '80-84', '85-89', '85-89', '85-89', '85-89', '85-89', '85-89', '85-89', '85-89', '85-89', '85-89', '16-17', '16-17', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+', '90+')
cw2 = c(0.880881396147728, 0.915652209483253, 0.880881396147728, 0.915652209483253, 0.880881396147728, 0.915652209483253, 0.66505869837287, 0.662800654452411, 0.880881396147728, 0.915652209483253, 0.880881396147728, 0.915652209483253, 0.880881396147728, 0.915652209483253, 0.880881396147728, 0.915652209483253, 0.880881396147728, 0.915652209483253, 0.880881396147728, 0.915652209483253, 0.880881396147728, 0.915652209483253, 0.863698144490791, 0.933260367430998, 0.863698144490791, 0.933260367430998, 0.880881396147728, 0.915652209483253, 0.865875425510669, 0.894801751478044, 0.865875425510669, 0.894801751478044, 0.865875425510669, 0.894801751478044, 0.865875425510669, 0.894801751478044, 0.865875425510669, 0.894801751478044, 0.872808316551781, 0.895031377820043, 0.872808316551781, 0.895031377820043, 0.872808316551781, 0.895031377820043, 0.872808316551781, 0.895031377820043, 0.872808316551781, 0.895031377820043, 0.880881396147728, 0.915652209483253, 0.869993614927992, 0.915643145113206, 0.869993614927992, 0.915643145113206, 0.869993614927992, 0.915643145113206, 0.869993614927992, 0.915643145113206, 0.869993614927992, 0.915643145113206, 0.856976300386238, 0.861710607230982, 0.856976300386238, 0.861710607230982, 0.856976300386238, 0.861710607230982, 0.856976300386238, 0.861710607230982, 0.856976300386238, 0.861710607230982, 0.880881396147728, 0.915652209483253, 0.849846689374818, 0.870400246174799, 0.849846689374818, 0.870400246174799, 0.849846689374818, 0.870400246174799, 0.849846689374818, 0.870400246174799, 0.849846689374818, 0.870400246174799, 0.815221490506362, 0.823605870642231, 0.815221490506362, 0.823605870642231, 0.815221490506362, 0.823605870642231, 0.815221490506362, 0.823605870642231, 0.815221490506362, 0.823605870642231, 0.880881396147728, 0.915652209483253, 0.804841211342943, 0.836879570929616, 0.804841211342943, 0.836879570929616, 0.804841211342943, 0.836879570929616, 0.804841211342943, 0.836879570929616, 0.804841211342943, 0.836879570929616, 0.802008686860249, 0.816945100303802, 0.802008686860249, 0.816945100303802, 0.802008686860249, 0.816945100303802, 0.802008686860249, 0.816945100303802, 0.802008686860249, 0.816945100303802, 0.880881396147728, 0.915652209483253, 0.784427884630109, 0.809442623257697, 0.784427884630109, 0.809442623257697, 0.784427884630109, 0.809442623257697, 0.784427884630109, 0.809442623257697, 0.784427884630109, 0.809442623257697, 0.782236443558683, 0.798471807295663, 0.782236443558683, 0.798471807295663, 0.782236443558683, 0.798471807295663, 0.782236443558683, 0.798471807295663, 0.782236443558683, 0.798471807295663, 0.880881396147728, 0.915652209483253, 0.786970842149871, 0.802386849711793, 0.786970842149871, 0.802386849711793, 0.786970842149871, 0.802386849711793, 0.786970842149871, 0.802386849711793, 0.786970842149871, 0.802386849711793, 0.740581868142652, 0.790894093539571, 0.740581868142652, 0.790894093539571, 0.740581868142652, 0.790894093539571, 0.740581868142652, 0.790894093539571, 0.740581868142652, 0.790894093539571, 0.880881396147728, 0.915652209483253, 0.717231239066706, 0.772772080477255, 0.717231239066706, 0.772772080477255, 0.717231239066706, 0.772772080477255, 0.717231239066706, 0.772772080477255, 0.717231239066706, 0.772772080477255, 0.665353265376341, 0.717647853751886, 0.665353265376341, 0.717647853751886, 0.665353265376341, 0.717647853751886, 0.665353265376341, 0.717647853751886, 0.665353265376341, 0.717647853751886, 0.880881396147728, 0.915652209483253, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411, 0.66505869837287, 0.662800654452411)
co2 = c(0.877652281742187, 0.917965536040096, 0.877652281742187, 0.917965536040096, 0.877652281742187, 0.917965536040096, 0.665657184113675, 0.655816057510311, 0.877652281742187, 0.917965536040096, 0.877652281742187, 0.917965536040096, 0.877652281742187, 0.917965536040096, 0.877652281742187, 0.917965536040096, 0.877652281742187, 0.917965536040096, 0.877652281742187, 0.917965536040096, 0.877652281742187, 0.917965536040096, 0.856051371395557, 0.930075000884574, 0.856051371395557, 0.930075000884574, 0.877652281742187, 0.917965536040096, 0.858723380905297, 0.894197389345114, 0.858723380905297, 0.894197389345114, 0.858723380905297, 0.894197389345114, 0.858723380905297, 0.894197389345114, 0.858723380905297, 0.894197389345114, 0.869230496615478, 0.894844633061854, 0.869230496615478, 0.894844633061854, 0.869230496615478, 0.894844633061854, 0.869230496615478, 0.894844633061854, 0.869230496615478, 0.894844633061854, 0.877652281742187, 0.917965536040096, 0.869404311612675, 0.914603981442727, 0.869404311612675, 0.914603981442727, 0.869404311612675, 0.914603981442727, 0.869404311612675, 0.914603981442727, 0.869404311612675, 0.914603981442727, 0.854020440852654, 0.862675639666449, 0.854020440852654, 0.862675639666449, 0.854020440852654, 0.862675639666449, 0.854020440852654, 0.862675639666449, 0.854020440852654, 0.862675639666449, 0.877652281742187, 0.917965536040096, 0.846264078621191, 0.872078363431723, 0.846264078621191, 0.872078363431723, 0.846264078621191, 0.872078363431723, 0.846264078621191, 0.872078363431723, 0.846264078621191, 0.872078363431723, 0.806122652535395, 0.822153948959309, 0.806122652535395, 0.822153948959309, 0.806122652535395, 0.822153948959309, 0.806122652535395, 0.822153948959309, 0.806122652535395, 0.822153948959309, 0.877652281742187, 0.917965536040096, 0.798223006428326, 0.83588582527204, 0.798223006428326, 0.83588582527204, 0.798223006428326, 0.83588582527204, 0.798223006428326, 0.83588582527204, 0.798223006428326, 0.83588582527204, 0.791156533912125, 0.808584089604361, 0.791156533912125, 0.808584089604361, 0.791156533912125, 0.808584089604361, 0.791156533912125, 0.808584089604361, 0.791156533912125, 0.808584089604361, 0.877652281742187, 0.917965536040096, 0.77559196154198, 0.803429299318124, 0.77559196154198, 0.803429299318124, 0.77559196154198, 0.803429299318124, 0.77559196154198, 0.803429299318124, 0.77559196154198, 0.803429299318124, 0.774728008952233, 0.79705318447509, 0.774728008952233, 0.79705318447509, 0.774728008952233, 0.79705318447509, 0.774728008952233, 0.79705318447509, 0.774728008952233, 0.79705318447509, 0.877652281742187, 0.917965536040096, 0.783852211623099, 0.801226583727464, 0.783852211623099, 0.801226583727464, 0.783852211623099, 0.801226583727464, 0.783852211623099, 0.801226583727464, 0.783852211623099, 0.801226583727464, 0.729928806626513, 0.78806244879763, 0.729928806626513, 0.78806244879763, 0.729928806626513, 0.78806244879763, 0.729928806626513, 0.78806244879763, 0.729928806626513, 0.78806244879763, 0.877652281742187, 0.917965536040096, 0.709784770509061, 0.766707265436998, 0.709784770509061, 0.766707265436998, 0.709784770509061, 0.766707265436998, 0.709784770509061, 0.766707265436998, 0.709784770509061, 0.766707265436998, 0.665527798477831, 0.726701610743621, 0.665527798477831, 0.726701610743621, 0.665527798477831, 0.726701610743621, 0.665527798477831, 0.726701610743621, 0.665527798477831, 0.726701610743621, 0.877652281742187, 0.917965536040096, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311, 0.665657184113675, 0.655816057510311)
age5_start2 = c(0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.664475558184715, 0.708409650215048, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.916258604005471, 0.952876894802725, 0.916258604005471, 0.952876894802725, 0.90377268173794, 0.94760401074775, 0.919146491365592, 0.931804234287385, 0.919146491365592, 0.931804234287385, 0.919146491365592, 0.931804234287385, 0.919146491365592, 0.931804234287385, 0.919146491365592, 0.931804234287385, 0.920756141982323, 0.936522960211248, 0.920756141982323, 0.936522960211248, 0.920756141982323, 0.936522960211248, 0.920756141982323, 0.936522960211248, 0.920756141982323, 0.936522960211248, 0.90377268173794, 0.94760401074775, 0.914951036675339, 0.929936780546354, 0.914951036675339, 0.929936780546354, 0.914951036675339, 0.929936780546354, 0.914951036675339, 0.929936780546354, 0.914951036675339, 0.929936780546354, 0.900041875839447, 0.912657597370535, 0.900041875839447, 0.912657597370535, 0.900041875839447, 0.912657597370535, 0.900041875839447, 0.912657597370535, 0.900041875839447, 0.912657597370535, 0.90377268173794, 0.94760401074775, 0.869464153375748, 0.887665462704234, 0.869464153375748, 0.887665462704234, 0.869464153375748, 0.887665462704234, 0.869464153375748, 0.887665462704234, 0.869464153375748, 0.887665462704234, 0.870711285432271, 0.881764281395693, 0.870711285432271, 0.881764281395693, 0.870711285432271, 0.881764281395693, 0.870711285432271, 0.881764281395693, 0.870711285432271, 0.881764281395693, 0.90377268173794, 0.94760401074775, 0.840093248440067, 0.862742326866071, 0.840093248440067, 0.862742326866071, 0.840093248440067, 0.862742326866071, 0.840093248440067, 0.862742326866071, 0.840093248440067, 0.862742326866071, 0.791015441307457, 0.858852805989364, 0.791015441307457, 0.858852805989364, 0.791015441307457, 0.858852805989364, 0.791015441307457, 0.858852805989364, 0.791015441307457, 0.858852805989364, 0.90377268173794, 0.94760401074775, 0.808660893931789, 0.811320224385668, 0.808660893931789, 0.811320224385668, 0.808660893931789, 0.811320224385668, 0.808660893931789, 0.811320224385668, 0.808660893931789, 0.811320224385668, 0.809953474631771, 0.857120537281961, 0.809953474631771, 0.857120537281961, 0.809953474631771, 0.857120537281961, 0.809953474631771, 0.857120537281961, 0.809953474631771, 0.857120537281961, 0.90377268173794, 0.94760401074775, 0.78503174251992, 0.797294213822586, 0.78503174251992, 0.797294213822586, 0.78503174251992, 0.797294213822586, 0.78503174251992, 0.797294213822586, 0.78503174251992, 0.797294213822586, 0.75666313955895, 0.791180046658543, 0.75666313955895, 0.791180046658543, 0.75666313955895, 0.791180046658543, 0.75666313955895, 0.791180046658543, 0.75666313955895, 0.791180046658543, 0.90377268173794, 0.94760401074775, 0.70172281327388, 0.809178318824506, 0.70172281327388, 0.809178318824506, 0.70172281327388, 0.809178318824506, 0.70172281327388, 0.809178318824506, 0.70172281327388, 0.809178318824506, 0.651909890832126, 0.730385898254718, 0.651909890832126, 0.730385898254718, 0.651909890832126, 0.730385898254718, 0.651909890832126, 0.730385898254718, 0.651909890832126, 0.730385898254718, 0.90377268173794, 0.94760401074775, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048)
mx2 = c(0.003582, 0.004321, 0.000213, 0.000242, 6.4e-05, 7.2e-05, 0.424693, 0.481498, 6.2e-05, 8.1e-05, 5.7e-05, 0.000105, 7.9e-05, 0.000125, 9.2e-05, 0.000116, 9.8e-05, 0.000169, 0.000148, 0.00022, 0.000159, 0.000303, 0.000211, 0.000387, 0.000194, 0.000415, 0.000125, 0.000132, 0.000179, 0.000503, 0.000201, 0.000498, 0.000215, 0.000479, 2e-04, 0.00047, 0.000218, 0.000513, 0.000244, 0.000538, 0.000259, 0.000543, 0.00027, 0.000574, 0.000304, 0.000629, 0.000302, 0.000664, 9.8e-05, 0.000102, 0.000358, 0.000711, 0.000369, 0.000772, 0.000436, 0.000756, 0.000451, 0.000861, 0.000525, 0.000893, 0.000554, 0.000968, 0.000583, 0.001051, 0.000746, 0.001212, 0.000703, 0.001179, 0.000771, 0.001291, 6.4e-05, 9.4e-05, 0.000829, 0.001431, 0.000916, 0.001535, 0.001028, 0.001678, 0.001098, 0.001853, 0.001261, 0.001962, 0.001361, 0.002226, 0.001495, 0.002306, 0.00162, 0.002573, 0.001772, 0.002719, 0.001899, 0.003047, 8.5e-05, 8.9e-05, 0.002091, 0.003239, 0.002277, 0.003496, 0.002478, 0.003755, 0.002591, 0.004021, 0.002773, 0.004318, 0.003089, 0.004653, 0.0034, 0.005192, 0.003689, 0.005695, 0.004082, 0.006208, 0.004403, 0.006728, 7.9e-05, 8.3e-05, 0.004852, 0.007414, 0.005299, 0.008049, 0.006098, 0.008998, 0.006478, 0.009929, 0.007006, 0.010735, 0.007698, 0.011872, 0.008278, 0.012985, 0.009053, 0.01416, 0.010082, 0.01549, 0.01088, 0.016987, 6.1e-05, 7.3e-05, 0.01203, 0.017956, 0.01297, 0.02001, 0.014884, 0.021869, 0.017035, 0.025311, 0.018668, 0.027602, 0.020912, 0.030891, 0.023611, 0.034948, 0.026807, 0.03867, 0.030388, 0.043514, 0.034189, 0.048056, 6.4e-05, 6.4e-05, 0.038372, 0.054329, 0.043276, 0.060667, 0.049059, 0.067296, 0.056819, 0.076235, 0.064521, 0.087106, 0.074049, 0.09777, 0.085076, 0.111136, 0.096453, 0.124636, 0.110923, 0.141065, 0.124474, 0.160029, 5.6e-05, 6.2e-05, 0.140894, 0.171303, 0.159746, 0.194057, 0.18005, 0.215207, 0.201066, 0.239683, 0.226271, 0.268883, 0.255483, 0.301158, 0.286263, 0.339814, 0.308323, 0.360074, 0.343826, 0.390059, 0.373434, 0.45198)
qx2 = c(0.003576, 0.004312, 0.000213, 0.000242, 6.4e-05, 7.2e-05, 0.350306, 0.38807, 6.2e-05, 8.1e-05, 5.7e-05, 0.000105, 7.9e-05, 0.000125, 9.2e-05, 0.000116, 9.8e-05, 0.000169, 0.000148, 0.00022, 0.000159, 0.000303, 0.000211, 0.000387, 0.000194, 0.000415, 0.000125, 0.000132, 0.000179, 0.000503, 0.000201, 0.000498, 0.000215, 0.000478, 2e-04, 0.00047, 0.000218, 0.000513, 0.000244, 0.000538, 0.000259, 0.000543, 0.00027, 0.000574, 0.000304, 0.000629, 0.000302, 0.000664, 9.8e-05, 0.000102, 0.000358, 0.000711, 0.000369, 0.000772, 0.000436, 0.000755, 0.000451, 0.000861, 0.000525, 0.000892, 0.000554, 0.000967, 0.000583, 0.00105, 0.000746, 0.001211, 0.000703, 0.001178, 0.00077, 0.00129, 6.4e-05, 9.4e-05, 0.000828, 0.00143, 0.000916, 0.001534, 0.001027, 0.001676, 0.001098, 0.001851, 0.00126, 0.00196, 0.00136, 0.002223, 0.001494, 0.002304, 0.001618, 0.00257, 0.00177, 0.002715, 0.001897, 0.003042, 8.5e-05, 8.9e-05, 0.002089, 0.003233, 0.002274, 0.00349, 0.002474, 0.003748, 0.002587, 0.004013, 0.00277, 0.004309, 0.003084, 0.004642, 0.003395, 0.005178, 0.003682, 0.005678, 0.004073, 0.006189, 0.004393, 0.006705, 7.9e-05, 8.3e-05, 0.004841, 0.007386, 0.005285, 0.008017, 0.006079, 0.008958, 0.006457, 0.00988, 0.006982, 0.010678, 0.007668, 0.011802, 0.008244, 0.012901, 0.009012, 0.01406, 0.010032, 0.015371, 0.010821, 0.016844, 6.1e-05, 7.3e-05, 0.011958, 0.017796, 0.012887, 0.019812, 0.014774, 0.021632, 0.016891, 0.024995, 0.018495, 0.027226, 0.020696, 0.030421, 0.023336, 0.034348, 0.026453, 0.037937, 0.029934, 0.042587, 0.033615, 0.046928, 6.4e-05, 6.4e-05, 0.03765, 0.052892, 0.042359, 0.058881, 0.047884, 0.065106, 0.05525, 0.073435, 0.062504, 0.083471, 0.071406, 0.093214, 0.081605, 0.105286, 0.092016, 0.117324, 0.105094, 0.131771, 0.117181, 0.148173, 5.6e-05, 6.2e-05, 0.131622, 0.157788, 0.14793, 0.176893, 0.165179, 0.1943, 0.182699, 0.214033, 0.203273, 0.237018, 0.226544, 0.261745, 0.25042, 0.290462, 0.26714, 0.305138, 0.293389, 0.326401, 0.314678, 0.368665)
lx2 = c(1e+05, 1e+05, 99642.4, 99568.8, 99558.3, 99475, 2787, 1159.3, 99551.9, 99467.8, 99545.8, 99459.7, 99540.1, 99449.3, 99532.2, 99436.9, 99523.1, 99425.4, 99513.3, 99408.5, 99498.6, 99386.7, 99482.8, 99356.5, 99461.8, 99318, 99621.2, 99544.7, 99442.6, 99276.8, 99424.8, 99226.9, 99404.8, 99177.4, 99383.4, 99130, 99363.5, 99083.4, 99341.9, 99032.6, 99317.7, 98979.3, 99291.9, 98925.6, 99265.1, 98868.8, 99234.9, 98806.7, 99608.8, 99531.5, 99204.9, 98741.1, 99169.4, 98670.9, 99132.9, 98594.7, 99089.7, 98520.2, 99045, 98435.4, 98993, 98347.6, 98938.1, 98252.5, 98880.5, 98149.3, 98806.7, 98030.4, 98737.2, 97914.9, 99599, 99521.4, 98661.2, 97788.6, 98579.5, 97648.7, 98489.2, 97498.9, 98388, 97335.5, 98280, 97155.3, 98156.2, 96964.9, 98022.7, 96749.3, 97876.3, 96526.4, 97717.9, 96278.4, 97544.9, 96017, 99592.6, 99512, 97359.9, 95724.8, 97156.5, 95415.3, 96935.5, 95082.3, 96695.6, 94725.9, 96445.5, 94345.8, 96178.3, 93939.3, 95881.7, 93503.2, 95556.2, 93019, 95204.4, 92490.8, 94816.6, 91918.3, 99584.1, 99503.1, 94400, 91302, 93943.1, 90627.6, 93446.6, 89901.1, 92878.5, 89095.8, 92278.7, 88215.5, 91634.5, 87273.5, 90931.8, 86243.5, 90182.1, 85130.9, 89369.4, 83933.9, 88472.9, 82643.8, 99576.3, 99494.8, 87515.5, 81251.8, 86469, 79805.8, 85354.7, 78224.7, 84093.7, 76532.5, 82673.2, 74619.6, 81144.2, 72588, 79464.8, 70379.8, 77610.5, 67962.4, 75557.5, 65384.2, 73295.7, 62599.6, 99570.3, 99487.5, 70831.9, 59662, 68165.1, 56506.3, 65277.7, 53179.2, 62152, 49716.9, 58718.1, 46065.9, 55047.9, 42220.8, 51117.2, 38285.2, 46945.8, 34254.4, 42626.1, 30235.5, 38146.3, 26251.3, 99563.9, 99481.1, 33676.3, 22361.6, 29243.8, 18833.2, 24917.7, 15501.7, 20801.8, 12489.8, 17001.4, 9816.5, 13545.4, 7489.8, 10476.8, 5529.4, 7853.2, 3923.3, 5755.3, 2726.2, 4066.8, 1836.3)
dx2 = c(357.6, 431.2, 21.2, 24.1, 6.4, 7.2, 976.3, 449.9, 6.2, 8.1, 5.6, 10.4, 7.9, 12.4, 9.1, 11.5, 9.8, 16.8, 14.7, 21.9, 15.8, 30.2, 20.9, 38.5, 19.3, 41.2, 12.4, 13.2, 17.8, 49.9, 20, 49.4, 21.4, 47.5, 19.9, 46.6, 21.6, 50.8, 24.3, 53.3, 25.7, 53.7, 26.9, 56.7, 30.2, 62.1, 30, 65.6, 9.8, 10.1, 35.5, 70.2, 36.6, 76.2, 43.2, 74.5, 44.7, 84.8, 52, 87.8, 54.8, 95.1, 57.7, 103.2, 73.8, 118.9, 69.4, 115.5, 76.1, 126.3, 6.4, 9.4, 81.7, 139.8, 90.2, 149.8, 101.2, 163.4, 108, 180.2, 123.8, 190.4, 133.5, 215.6, 146.4, 222.9, 158.4, 248.1, 173, 261.4, 185, 292.1, 8.5, 8.9, 203.4, 309.5, 221, 333, 239.9, 356.4, 250.2, 380.1, 267.1, 406.5, 296.6, 436.1, 325.5, 484.2, 351.9, 528.2, 387.8, 572.4, 416.5, 616.3, 7.8, 8.3, 456.9, 674.4, 496.5, 726.5, 568.1, 805.3, 599.7, 880.3, 644.3, 942, 702.7, 1030, 749.7, 1112.6, 812.7, 1197, 896.5, 1290.1, 957.3, 1392.1, 6, 7.3, 1046.6, 1446, 1114.3, 1581.1, 1261, 1692.2, 1420.4, 1912.9, 1529.1, 2031.6, 1679.4, 2208.2, 1854.4, 2417.4, 2053, 2578.3, 2261.7, 2784.5, 2463.8, 2937.7, 6.3, 6.4, 2666.8, 3155.7, 2887.4, 3327.1, 3125.8, 3462.3, 3433.9, 3651, 3670.1, 3845.2, 3930.7, 3935.5, 4171.4, 4030.9, 4319.7, 4018.9, 4479.8, 3984.2, 4470, 3889.7, 5.6, 6.2, 4432.5, 3528.4, 4326, 3331.5, 4115.9, 3012, 3800.5, 2673.2, 3455.9, 2326.7, 3068.6, 1960.4, 2623.6, 1606.1, 2097.9, 1197.2, 1688.5, 889.8, 1279.7, 677)
ex2 = c(83.33, 79.67, 82.63, 79.02, 73.7, 70.09, 2.1, 1.94, 72.7, 69.09, 71.71, 68.1, 70.71, 67.11, 69.72, 66.12, 68.72, 65.12, 67.73, 64.13, 66.74, 63.15, 65.75, 62.17, 64.76, 61.19, 81.65, 78.04, 63.78, 60.22, 62.79, 59.25, 61.8, 58.28, 60.81, 57.3, 59.82, 56.33, 58.84, 55.36, 57.85, 54.39, 56.87, 53.42, 55.88, 52.45, 54.9, 51.48, 80.66, 77.05, 53.92, 50.51, 52.93, 49.55, 51.95, 48.59, 50.98, 47.62, 50, 46.66, 49.03, 45.71, 48.05, 44.75, 47.08, 43.8, 46.11, 42.85, 45.15, 41.9, 79.67, 76.06, 44.18, 40.95, 43.22, 40.01, 42.26, 39.07, 41.3, 38.14, 40.34, 37.21, 39.39, 36.28, 38.45, 35.36, 37.5, 34.44, 36.56, 33.53, 35.63, 32.62, 78.67, 75.06, 34.69, 31.71, 33.77, 30.81, 32.84, 29.92, 31.92, 29.03, 31, 28.15, 30.09, 27.27, 29.18, 26.39, 28.28, 25.53, 27.38, 24.67, 26.49, 23.82, 77.68, 74.07, 25.61, 22.98, 24.73, 22.14, 23.86, 21.32, 23, 20.51, 22.15, 19.71, 21.3, 18.91, 20.46, 18.13, 19.62, 17.36, 18.8, 16.6, 17.98, 15.86, 76.68, 73.08, 17.17, 15.12, 16.38, 14.38, 15.58, 13.66, 14.81, 12.96, 14.06, 12.27, 13.31, 11.6, 12.58, 10.95, 11.87, 10.32, 11.18, 9.71, 10.51, 9.12, 75.69, 72.08, 9.86, 8.55, 9.22, 8, 8.61, 7.46, 8.02, 6.95, 7.46, 6.46, 6.92, 6, 6.41, 5.57, 5.94, 5.17, 5.49, 4.79, 5.08, 4.44, 74.69, 71.09, 4.68, 4.12, 4.32, 3.8, 3.98, 3.51, 3.67, 3.23, 3.38, 2.98, 3.11, 2.75, 2.88, 2.55, 2.67, 2.38, 2.47, 2.21, 2.28, 2.04)
tto2 = c(0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.664475558184715, 0.708409650215048, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.90377268173794, 0.94760401074775, 0.916258604005471, 0.952876894802725, 0.916258604005471, 0.952876894802725, 0.90377268173794, 0.94760401074775, 0.919146491365592, 0.931804234287385, 0.919146491365592, 0.931804234287385, 0.919146491365592, 0.931804234287385, 0.919146491365592, 0.931804234287385, 0.919146491365592, 0.931804234287385, 0.920756141982323, 0.936522960211248, 0.920756141982323, 0.936522960211248, 0.920756141982323, 0.936522960211248, 0.920756141982323, 0.936522960211248, 0.920756141982323, 0.936522960211248, 0.90377268173794, 0.94760401074775, 0.914951036675339, 0.929936780546354, 0.914951036675339, 0.929936780546354, 0.914951036675339, 0.929936780546354, 0.914951036675339, 0.929936780546354, 0.914951036675339, 0.929936780546354, 0.900041875839447, 0.912657597370535, 0.900041875839447, 0.912657597370535, 0.900041875839447, 0.912657597370535, 0.900041875839447, 0.912657597370535, 0.900041875839447, 0.912657597370535, 0.90377268173794, 0.94760401074775, 0.869464153375748, 0.887665462704234, 0.869464153375748, 0.887665462704234, 0.869464153375748, 0.887665462704234, 0.869464153375748, 0.887665462704234, 0.869464153375748, 0.887665462704234, 0.870711285432271, 0.881764281395693, 0.870711285432271, 0.881764281395693, 0.870711285432271, 0.881764281395693, 0.870711285432271, 0.881764281395693, 0.870711285432271, 0.881764281395693, 0.90377268173794, 0.94760401074775, 0.840093248440067, 0.862742326866071, 0.840093248440067, 0.862742326866071, 0.840093248440067, 0.862742326866071, 0.840093248440067, 0.862742326866071, 0.840093248440067, 0.862742326866071, 0.791015441307457, 0.858852805989364, 0.791015441307457, 0.858852805989364, 0.791015441307457, 0.858852805989364, 0.791015441307457, 0.858852805989364, 0.791015441307457, 0.858852805989364, 0.90377268173794, 0.94760401074775, 0.808660893931789, 0.811320224385668, 0.808660893931789, 0.811320224385668, 0.808660893931789, 0.811320224385668, 0.808660893931789, 0.811320224385668, 0.808660893931789, 0.811320224385668, 0.809953474631771, 0.857120537281961, 0.809953474631771, 0.857120537281961, 0.809953474631771, 0.857120537281961, 0.809953474631771, 0.857120537281961, 0.809953474631771, 0.857120537281961, 0.90377268173794, 0.94760401074775, 0.78503174251992, 0.797294213822586, 0.78503174251992, 0.797294213822586, 0.78503174251992, 0.797294213822586, 0.78503174251992, 0.797294213822586, 0.78503174251992, 0.797294213822586, 0.75666313955895, 0.791180046658543, 0.75666313955895, 0.791180046658543, 0.75666313955895, 0.791180046658543, 0.75666313955895, 0.791180046658543, 0.75666313955895, 0.791180046658543, 0.90377268173794, 0.94760401074775, 0.70172281327388, 0.809178318824506, 0.70172281327388, 0.809178318824506, 0.70172281327388, 0.809178318824506, 0.70172281327388, 0.809178318824506, 0.70172281327388, 0.809178318824506, 0.651909890832126, 0.730385898254718, 0.651909890832126, 0.730385898254718, 0.651909890832126, 0.730385898254718, 0.651909890832126, 0.730385898254718, 0.651909890832126, 0.730385898254718, 0.90377268173794, 0.94760401074775, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048, 0.664475558184715, 0.708409650215048)
dsu_2014 = c(0.9103, 0.9446, 0.9103, 0.9446, 0.9103, 0.9446, 0.5934, 0.6946, 0.9103, 0.9446, 0.9103, 0.9446, 0.9103, 0.9446, 0.9103, 0.9446, 0.9103, 0.9446, 0.9103, 0.9446, 0.9109, 0.9433, 0.9112, 0.942, 0.9114, 0.9406, 0.9103, 0.9446, 0.9115, 0.9392, 0.9113, 0.9378, 0.9111, 0.9363, 0.9106, 0.9348, 0.9101, 0.9332, 0.9094, 0.9317, 0.9086, 0.93, 0.9077, 0.9284, 0.9066, 0.9267, 0.9055, 0.925, 0.9103, 0.9446, 0.9042, 0.9232, 0.9028, 0.9214, 0.9013, 0.9196, 0.8998, 0.9177, 0.8981, 0.9158, 0.8963, 0.9138, 0.8945, 0.9118, 0.8925, 0.9098, 0.8905, 0.9077, 0.8883, 0.9056, 0.9103, 0.9446, 0.8861, 0.9034, 0.8838, 0.9012, 0.8814, 0.899, 0.879, 0.8967, 0.8764, 0.8943, 0.8738, 0.8919, 0.871, 0.8895, 0.8682, 0.887, 0.8654, 0.8845, 0.8624, 0.882, 0.9103, 0.9446, 0.8594, 0.8793, 0.8562, 0.8767, 0.853, 0.874, 0.8498, 0.8712, 0.8464, 0.8684, 0.8429, 0.8656, 0.8394, 0.8627, 0.8358, 0.8598, 0.8321, 0.8568, 0.8283, 0.8538, 0.9103, 0.9446, 0.8245, 0.8507, 0.8206, 0.8476, 0.8165, 0.8444, 0.8124, 0.8412, 0.8082, 0.8379, 0.8039, 0.8346, 0.7996, 0.8313, 0.7951, 0.8278, 0.7905, 0.8244, 0.7859, 0.8209, 0.9103, 0.9446, 0.7812, 0.8174, 0.7763, 0.8138, 0.7714, 0.8101, 0.7664, 0.8065, 0.7613, 0.8027, 0.7561, 0.799, 0.7507, 0.7952, 0.7453, 0.7913, 0.7398, 0.7875, 0.7342, 0.7835, 0.9103, 0.9446, 0.7285, 0.7796, 0.7227, 0.7756, 0.7167, 0.7715, 0.7107, 0.7675, 0.7045, 0.7634, 0.6983, 0.7592, 0.692, 0.755, 0.6855, 0.7508, 0.6789, 0.7466, 0.6723, 0.7424, 0.9103, 0.9446, 0.6655, 0.7381, 0.6587, 0.7338, 0.6517, 0.7295, 0.6447, 0.7252, 0.6376, 0.7208, 0.6304, 0.7165, 0.6231, 0.7121, 0.6158, 0.7077, 0.6084, 0.7033, 0.6009, 0.699)

n_mvh_df = tibble(age=age2,
                  sex=sex2,
                  age5_str=age5_str2,
                  cw=cw2,
                  co=co2,
                  age5_start=age5_start2,
                  mx=mx2,
                  qx=qx2,
                  lx=lx2,
                  dx=dx2,
                  ex=ex2,
                  tto=tto2,
                  dsu_2014=dsu_2014)

# List of objects to remove
objects_to_remove <- c("age1", "sex1", "age_start1", "age5_str1", "tto1", "mx1", "qx1", "lx1", "dx1", "ex1",
                       "age2", "sex2", "age5_str2", "cw2", "co2", "age5_start2", "mx2", "qx2", "lx2", "dx2", "ex2", "tto2", "dsu_2014")

# Loop over the objects and remove them if they exist
for (obj in objects_to_remove) {
  if (exists(obj)) {
    rm(list=obj)
  }
}

# ui ----
ui <- page_navbar(
  theme = bs_theme(preset = "shiny", "primary" = "#0675DD"),
  lang = "en",
  title = "Nordic Shortfall Calculator Demo",
  sidebar = sidebar(HTML('<p style="font-weight:bold;">Input for</p>'), width = 300, sidebar_acc),
  nav_spacer(),
  generate_nav_panel("Norway", "n")
)

# server ----
server <- function(input, output, session) {
  n_dat = reactiveValues()
  
  observe({
    
    util_df = switch(input$n_utils,
                     "d_mvh" = n_mvh_df,
                     "d_vanHout" = n_ref_df,
                     "d_tto" = n_ref_df,
                     "d_dsu" = n_ref_df,
                     "d_dsu_2014" = n_ref_df,
                     n_ref_df
    )
    
    utils = switch(input$n_utils,
                   "d_mvh" = "tto",
                   "d_vanHout" = "cw",
                   "d_tto" = "tto",
                   "d_dsu" = "co",
                   "d_dsu_2014" = "dsu_2014",
                   "cw"
    )
    
    n_dat$res = compQale(
      ons_df = util_df,
      prop_female = input$n_sex_mix/100,
      start_age = input$n_start_age,
      disc_rate = input$n_disc_rate/100,
      utils = utils
    )
    
    n_dat$shortfall_abs = n_dat$res$Qx[1] - input$n_remaining_qalys
    n_dat$shortfall_prop = n_dat$shortfall_abs / n_dat$res$Qx[1]
    n_dat$q_weight = ifelse(n_dat$shortfall_prop >= 0.95 | n_dat$shortfall_abs >= 18, 1.7,
                            ifelse(n_dat$shortfall_prop >= 0.85 | n_dat$shortfall_abs >= 12, 1.2, 1)
    )
  })
  
  # absolute shortfall highchart
  highchart_n_as <- reactive({
    create_highchart_as(n_dat, input$n_remaining_qalys, "#7cb5ec")
  })
  
  # proportional shortfall highchart ----
  highchart_n_ps = reactive({
    short_fall = data.frame(
      type = c("With disease", "% Shortfall"),
      percent = c(100 - n_dat$shortfall_prop*100, n_dat$shortfall_prop*100),
      col = c("green","gray")
    )
    
    shortfall_str = paste0(round(n_dat$shortfall_prop*100,1))
    shortfall_str = paste0("Proportional<br>QALY<br>shortfall:<br><b>",shortfall_str,"%</b>")
    
    p1 = highchart() %>%
      hc_add_series(short_fall, "pie", hcaes(name = type, y = percent), name = "QALE", innerSize="70%") %>%
      hc_title(text = shortfall_str, align = "center",x=0, verticalAlign = 'middle', floating = "true", style = list(fontSize = "16px")) %>%
      hc_chart(
        style = list(
          fontFamily = "Inter"
        )
      ) %>%
      hc_tooltip(
        valueDecimals = 1,
        valueSuffix = '%'
      ) %>%
      hc_colors(c("#7cb5ec","gray"))
    
    return(p1)
  })
  
  # cumulative QALY highchart
  highchart_n_cq <- reactive({
    disc_str <- input$n_disc_rate > 0
    y_max <- max(n_dat$res$Qx[1])
    title <- paste0("QALYs without the disease: <b>", round(max(n_dat$res$Qx[1]), 2), "</b>", ifelse(disc_str, "(discounted)", ""))
    ytitle <- "Cumulative QALYs"
    
    plot_df <- data.frame(
      age = n_dat$res$age,
      var = n_dat$res[, 6]
    )
    
    p1 <- create_highchart(
      plot_df = plot_df,
      title = title,
      ytitle = ytitle,
      y_max = y_max,
      color = "#7cb5ec"
    )
    
    return(p1)
  })
  
  # HRQoL highchart
  highchart_n_hrqol <- reactive({
    disc_str <- input$n_disc_rate > 0
    y_max <- max(n_dat$res$Qx[1])
    title <- paste0("HRQoL over the lifecourse", ifelse(disc_str, "(undiscounted)", ""))
    ytitle <- "EQ-5D score"
    y_max <- 1
    
    plot_df <- data.frame(
      age = n_dat$res$age,
      var = n_dat$res[, 2]
    )
    
    p1 <- create_highchart(
      plot_df = plot_df,
      title = title,
      ytitle = ytitle,
      y_max = y_max,
      color = "#7cb5ec"
    )
    
    return(p1)
  })
  
  # cumulative survival highchart
  highchart_n_cs <- reactive({
    title <- paste0("Cumulative survival")
    ytitle <- "S(t)"
    y_max <- 1
    
    plot_df <- data.frame(
      age = n_dat$res$age,
      var = n_dat$res[, 5]
    )
    
    p1 <- create_highchart(
      plot_df = plot_df,
      title = title,
      ytitle = ytitle,
      y_max = y_max,
      color = "#7cb5ec"
    )
    
    return(p1)
  })
  
  # numeric outputs ----
  output$n_qales_healthy_txt = renderText({fRound(n_dat$res$Qx[1],2)})
  output$n_qales_ill_txt = renderText({fRound(input$n_remaining_qalys)})
  output$n_abs_short_txt = renderText({fRound(n_dat$shortfall_abs,2)})
  output$n_prop_short_txt = renderText({paste0(fRound(n_dat$shortfall_prop*100,2),"%")})
  output$n_mltplr_txt = renderText({paste0("x ",n_dat$q_weight)})

  # highcharts ----
  output$n_hc_as = renderHighchart({highchart_n_as()})
  output$n_hc_ps = renderHighchart({highchart_n_ps()})
  output$n_hc_cq = renderHighchart({highchart_n_cq()})
  output$n_hc_hrqol = renderHighchart({highchart_n_hrqol()})
  output$n_hc_cs = renderHighchart({highchart_n_cs()})
  
}

# RUN APP ----
shinyApp(ui, server)